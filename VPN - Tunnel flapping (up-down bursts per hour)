make_col path:lower(string(EXTRA.path))
filter contains(string(path), "firewall")

// base
make_table
pick_col
  EventTime:parse_isotime(string(FIELDS.timestamp)),
  SubType:string(FIELDS.subtype),
  Action:string(FIELDS.action),
  User:string(FIELDS.user)

filter SubType = "vpn" and not is_null(EventTime)

make_col action_l:lower(string(Action))
filter (action_l = "tunnel-up" or action_l = "tunnel-down")

aggregate group_by(User, Bucket:format_time(EventTime, 'YYYY-MM-DD HH24')),
  Ups:sum(if(action_l = "tunnel-up", 1, 0)),
  Downs:sum(if(action_l = "tunnel-down", 1, 0))

make_col Flaps:(Ups + Downs)
filter Flaps >= 20
sort desc(Flaps)
limit 200
