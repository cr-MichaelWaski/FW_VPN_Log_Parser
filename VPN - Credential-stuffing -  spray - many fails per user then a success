make_col path:lower(string(EXTRA.path))
filter contains(string(path), "firewall")

make_table
pick_col
  EventTime:parse_isotime(string(FIELDS.timestamp)),
  SubType:string(FIELDS.subtype),
  Action:string(FIELDS.action),
  User:string(FIELDS.user),
  RemoteIP:string(FIELDS.remip),
  Reason:string(FIELDS.reason)

filter SubType = "vpn" and not is_null(EventTime)

// Consider success if action indicates “up/login” OR reason mentions success
make_col action_l:lower(string(Action)), reason_l:lower(string(Reason))
make_col IsSuccess:(action_l = "tunnel-up" or action_l = "login" or contains(reason_l, "success"))
make_col IsFail:(not IsSuccess)

aggregate group_by(User, Bucket:format_time(EventTime, 'YYYY-MM-DD HH24')),
  Fails:sum(if(IsFail, 1, 0)),
  Successes:sum(if(IsSuccess, 1, 0)),
  RemoteIPs:array_agg_distinct(RemoteIP)

filter Fails >= 10 and Successes >= 1
sort desc(Fails), desc(Successes)
